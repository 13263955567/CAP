



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Project documentation with Markdown.">
      
      
        <link rel="canonical" href="https://cap.dotnet-chain.com/user-guide/api-interface/">
      
      
        <meta name="author" content="CAP Team">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.3.0">
    
    
      
        <title>API Interface - CAP</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.572ca0f0.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#ab47bc">
      
    
    
      <script src="../../assets/javascripts/modernizr.962652e9.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
      <link rel="manifest" href="../../manifest.webmanifest">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="purple" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#interfaces" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://cap.dotnet-chain.com" title="CAP" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                CAP
              </span>
              <span class="md-header-nav__topic">
                API Interface
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/dotnetcore/cap/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      dotnetcore/CAP
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="Home" class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../getting-started/" title="User Guide" class="md-tabs__link md-tabs__link--active">
          User Guide
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../user-guide-cn/getting-started/" title="使用指南" class="md-tabs__link">
          使用指南
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../about/release-notes/" title="About" class="md-tabs__link">
          About
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://cap.dotnet-chain.com" title="CAP" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    CAP
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/dotnetcore/cap/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      dotnetcore/CAP
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../getting-started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        API Interface
      </label>
    
    <a href="./" title="API Interface" class="md-nav__link md-nav__link--active">
      API Interface
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#publish-send" title="Publish &amp; Send" class="md-nav__link">
    Publish &amp; Send
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transactions" title="Transactions" class="md-nav__link">
    Transactions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entityframework" title="EntityFramework" class="md-nav__link">
    EntityFramework
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dapper" title="Dapper" class="md-nav__link">
    Dapper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribe-consume" title="Subscribe &amp; Consume" class="md-nav__link">
    Subscribe &amp; Consume
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exceptional-case" title="Exceptional case" class="md-nav__link">
    Exceptional case
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kafka" title="Kafka:" class="md-nav__link">
    Kafka:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rabbitmq" title="RabbitMQ:" class="md-nav__link">
    RabbitMQ:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../design/" title="Design Principle" class="md-nav__link">
      Design Principle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/" title="Implementation Mechanisms" class="md-nav__link">
      Implementation Mechanisms
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../transaction/" title="Distributed Transactions" class="md-nav__link">
      Distributed Transactions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      使用指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        使用指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-guide-cn/getting-started/" title="快速开始" class="md-nav__link">
      快速开始
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-guide-cn/api-interface/" title="API 接口" class="md-nav__link">
      API 接口
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-guide-cn/configuration/" title="配置" class="md-nav__link">
      配置
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-guide-cn/design-principle/" title="设计原理" class="md-nav__link">
      设计原理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-guide-cn/implementation-mechanisms/" title="实现" class="md-nav__link">
      实现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-guide-cn/distributed-transactions/" title="分布式事务" class="md-nav__link">
      分布式事务
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../user-guide-cn/faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/release-notes/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../about/contact-us/" title="Contact Us" class="md-nav__link">
      Contact Us
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#publish-send" title="Publish &amp; Send" class="md-nav__link">
    Publish &amp; Send
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transactions" title="Transactions" class="md-nav__link">
    Transactions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entityframework" title="EntityFramework" class="md-nav__link">
    EntityFramework
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dapper" title="Dapper" class="md-nav__link">
    Dapper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribe-consume" title="Subscribe &amp; Consume" class="md-nav__link">
    Subscribe &amp; Consume
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exceptional-case" title="Exceptional case" class="md-nav__link">
    Exceptional case
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kafka" title="Kafka:" class="md-nav__link">
    Kafka:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rabbitmq" title="RabbitMQ:" class="md-nav__link">
    RabbitMQ:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/dotnetcore/cap/edit/master/docs/user-guide/api-interface.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="interfaces">Interfaces<a class="headerlink" href="#interfaces" title="Permanent link">&para;</a></h1>
<p>CAP only has one interface,It is <code class="codehilite">ICapPublisher</code>, You can get its instance from the DI container and then call it.</p>
<h2 id="publish-send">Publish &amp; Send<a class="headerlink" href="#publish-send" title="Permanent link">&para;</a></h2>
<p>You can use the <code class="codehilite">Publish&lt;T&gt;</code> or <code class="codehilite">PublishAsync&lt;T&gt;</code>  methods defined in the <code class="codehilite">ICapPublisher</code> interface to send the event messages.</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">PublishController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICapPublisher</span> <span class="n">_capBus</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">PublishController</span><span class="p">(</span><span class="n">ICapPublisher</span> <span class="n">capPublisher</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_capBus</span> <span class="p">=</span> <span class="n">capPublisher</span><span class="p">;</span>
    <span class="p">}</span>

<span class="na">    [Route(&quot;~/adonet/transaction&quot;)]</span>
    <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">AdonetWithTransaction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">connection</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MySqlConnection</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">transaction</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">BeginTransaction</span><span class="p">(</span><span class="n">_capBus</span><span class="p">,</span> <span class="n">autoCommit</span><span class="p">:</span> <span class="k">true</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">//your business code</span>

<span class="hll">                <span class="n">_capBus</span><span class="p">.</span><span class="n">Publish</span><span class="p">(</span><span class="s">&quot;xxx.services.show.time&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
</span>            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
    <span class="p">}</span>

<span class="na">    [Route(&quot;~/ef/transaction&quot;)]</span>
    <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">EntityFrameworkWithTransaction</span><span class="p">([</span><span class="n">FromServices</span><span class="p">]</span><span class="n">AppDbContext</span> <span class="n">dbContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">trans</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">BeginTransaction</span><span class="p">(</span><span class="n">_capBus</span><span class="p">,</span> <span class="n">autoCommit</span><span class="p">:</span> <span class="k">true</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">//your business code</span>

<span class="hll">            <span class="n">_capBus</span><span class="p">.</span><span class="n">Publish</span><span class="p">(</span><span class="s">&quot;xxx.services.show.time&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>
</span>        <span class="p">}</span>

        <span class="k">return</span> <span class="nf">Ok</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
The following is the signature of the of the PublishAsync method</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">PublishAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">T</span> <span class="kt">object</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>By default,when this method(PublishAsync<T>) is called,CAP will create a transaction internally,
and then write messages into the <code class="codehilite">Cap.Published</code> message table.</p>
<p>In some situations,you may need a callback when a message is sent out, you can use the follwing
overload of the <code class="codehilite">PublishAsync&lt;T&gt;</code> method:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">PublishAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">T</span> <span class="kt">object</span><span class="p">,</span> <span class="kt">string</span> <span class="n">callBackName</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>In this overload method, <code class="codehilite">callbackName</code> is the callback name of the subscription method,when the consumption-side finished processing messages,CAP will return the processed result and also call the  specified subscription method</p>
<h3 id="transactions">Transactions<a class="headerlink" href="#transactions" title="Permanent link">&para;</a></h3>
<p>Transaction plays a very import role in CAP, It is a main factor to ensure the reliability of messaging. </p>
<p>In the process of sending a message to the message queue without transaction we can not ensure that messages are sent to the message queue successfully after we finish dealing the business logic,or messages are send to the message queque successfully but our bussiness logic is failed.</p>
<p>There is a variety of reasons that causing failure,eg:connection errors,network errors,etc.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only by putting the business logic and logic in the Publish of CAP in the same transaction so that we can enssure both them to be success or fail</p>
</div>
<p>The following two blocks of code snippet demonstrate how to use transactions in EntityFramework and dapper when publishing messages.</p>
<h4 id="entityframework">EntityFramework<a class="headerlink" href="#entityframework" title="Permanent link">&para;</a></h4>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">trans</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">BeginTransaction</span><span class="p">(</span><span class="n">_capBus</span><span class="p">,</span> <span class="n">autoCommit</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Your business logic。</span>

    <span class="n">_capBus</span><span class="p">.</span><span class="n">Publish</span><span class="p">(</span><span class="s">&quot;xxx.services.show.time&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>

    <span class="n">trans</span><span class="p">.</span><span class="n">Commit</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
When you set the <code class="codehilite"><span class="n">autoCommit</span><span class="o">:</span> <span class="kc">false</span></code>, you can put your business logic before or after the Publish logic,the only thing you need to do is to ensure that they are in the same transaction.</p>
<p>If you set the <code class="codehilite"><span class="n">autoCommit</span><span class="o">:</span> <span class="kc">true</span></code>, you need publish message <code class="codehilite">_capBus.Publish</code> at the last.</p>
<p>During the course,the message content will be serialized as json and stored in the message table.</p>
<h4 id="dapper">Dapper<a class="headerlink" href="#dapper" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">connection</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MySqlConnection</span><span class="p">(</span><span class="n">ConnectionString</span><span class="p">))</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">transaction</span> <span class="p">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">BeginTransaction</span><span class="p">(</span><span class="n">_capBus</span><span class="p">,</span> <span class="n">autoCommit</span><span class="p">:</span> <span class="k">false</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">//your business code</span>
        <span class="n">connection</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="s">&quot;insert into test(name) values(&#39;test&#39;)&quot;</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="p">(</span><span class="n">IDbTransaction</span><span class="p">)</span><span class="n">transaction</span><span class="p">.</span><span class="n">DbTransaction</span><span class="p">);</span>

        <span class="n">_capBus</span><span class="p">.</span><span class="n">Publish</span><span class="p">(</span><span class="s">&quot;sample.rabbitmq.mysql&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">);</span>

        <span class="n">transaction</span><span class="p">.</span><span class="n">Commit</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="subscribe-consume">Subscribe &amp; Consume<a class="headerlink" href="#subscribe-consume" title="Permanent link">&para;</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The businsess logics in the subscription side should be keep idempotent.</p>
<p>You can view more details in this <a href="https://github.com/dotnetcore/CAP/issues/29#issuecomment-451841287">ISSUE</a>.</p>
</div>
<p>Use <code class="codehilite">CapSubscribe[&quot;&quot;]</code> to decorate a method so that it can  subscribe messages published by CAP.</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="na">[CapSubscribe(&quot;xxx.services.bar&quot;)]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">BarMessageProcessor</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
You can also use multiple <code class="codehilite">CapSubscribe[&quot;&quot;]</code> to decorate a method so that you can subscribe messages from different sources accordingly.</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="na">[CapSubscribe(&quot;xxx.services.bar&quot;)]</span>
<span class="na">[CapSubscribe(&quot;xxx.services.foo&quot;)]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">BarAndFooMessageProcessor</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<code class="codehilite">xxx.services.bar</code> is the name of the message to be subscribed.And it has different name in different message queque Clients.for example,in kafka the name is called  Topic Name and in RAbbitMQ it is called RouteKey.</p>
<p>In RabbitMQ you can use regular expression in RouteKey:
<blockquote>
  <p> <cite title="Source Title">*</cite> (Asterisk) stands for  a single word.</p>
  <p> <cite title="Source Title">#</cite> (hash sign) standards for zero or more words.</p>
  <p class="small">See the following picture(P for Publisher,X for Exchange,C for consumer and Q for Queue)</p>
  <p><image src='../../img/rabbitmq-route.png'></image></p>
  <p class="small">In this example, we're going to send messages which all describe animals. The messages will be sent with a routing key that consists of three words (two dots). The first word in the routing key will describe a celerity, second a colour and third a species: "<celerity>.<colour>.<species>".</p>
  <p class="small">We created three bindings: Q1 is bound with binding key "<em>.orange.</em>" and Q2 with "<em>.</em>.rabbit" and "lazy.#".</p>
  <p class="small">These bindings can be summarised as:</p>
  <p class="small">Q1 is interested in all the orange animals.Q2 wants to hear everything about rabbits, and everything about lazy animals.A message with a routing key set to "quick.orange.rabbit" will be delivered to both queues. Message "lazy.orange.elephant" also will go to both of them. On the other hand "quick.orange.fox" will only go to the first queue, and "lazy.brown.fox" only to the second. "lazy.pink.rabbit" will be delivered to the second queue only once, even though it matches two bindings. "quick.brown.fox" doesn't match any binding so it will be discarded.</p>
  <p class="small">What happens if we break our contract and send a message with one or four words, like "orange" or "quick.orange.male.rabbit"? Well, these messages won't match any bindings and will be lost.</p>
  <p class="small">On the other hand "lazy.orange.male.rabbit", even though it has four words, will match the last binding and will be delivered to the second queue.</p>
</blockquote></p>
<p>In CAP, we called a method decorated by <code class="codehilite">CapSubscribe[]</code> a <strong>subscriber</strong>, you can group different subscribers.</p>
<p><strong>Group</strong> is a collection of subscribers,each group can have one or multiple consumers,but a subscriber can only belongs to a certain group(you can not put a subscriber into multiple groups).Messages subscribed by members in a certain group can only be consumed once.</p>
<p>If you do not specify any group when subscribing,CAP will put the subscriber into a default group named <code class="codehilite">cap.default.group</code></p>
<p>the following is a demo shows how to use group when subscribing.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="na">[CapSubscribe(&quot;xxx.services.foo&quot;, Group = &quot;moduleA&quot;)]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">FooMessageProcessor</span><span class="p">()</span>
<span class="p">{</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="exceptional-case">Exceptional case<a class="headerlink" href="#exceptional-case" title="Permanent link">&para;</a></h3>
<p>The following situations you shoud be aware of.</p>
<p><strong>① the subscription side has not started yet when publishing a message</strong></p>
<h4 id="kafka">Kafka:<a class="headerlink" href="#kafka" title="Permanent link">&para;</a></h4>
<p>In Kafka,published messages stored in the Persistent log files,so messages will not lost.when the subscription side started,it can still consume the message.</p>
<h4 id="rabbitmq">RabbitMQ:<a class="headerlink" href="#rabbitmq" title="Permanent link">&para;</a></h4>
<p>In RabbitMQ, the application will create Persistent Exchange and Queue at the <strong>first start</strong>, CAP will create a new consumer queue for each consumer group,<strong>because the application started but the subscription side hasn's start yet so there has no queue,thus the message can not be persited,and the published messages will lost</strong></p>
<p>There are two ways to solve this <code class="codehilite">message lost</code> issue in RamitMQ:</p>
<ul>
<li>
<p>Before the deployment of your application,you can create durable Exchange and Queue in RabbitMQ by hand,the default names them are (cap.default.topic, cap.default.group).</p>
</li>
<li>
<p>Run all instances in advance to ensure that both Exchange and Queue are initialized.</p>
</li>
</ul>
<p>It is highly recommanded that users adopt the second way,because it is easier to achieve.</p>
                
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://cap.dotnet-chain.com/user-guide/api-interface/";
      this.page.identifier =
        "/user-guide/api-interface/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//cap-1.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../getting-started/" title="Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Getting Started
              </span>
            </div>
          </a>
        
        
          <a href="../configuration/" title="Configuration" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Configuration
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 <a href="https://github.com/dotnetcore">.NET Core Community</a>, Maintained by the <a href="/about/contact-us/#cap-team">CAP Team</a>.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/dotnetcore/cap" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/ncc_community" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://weibo.com/dotnetcore" class="md-footer-social__link fa fa-weibo"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.a353778b.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>